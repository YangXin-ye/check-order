# 前台接口文档
## 数据准备
### 依赖
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.2.2.RELEASE</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.jlwl</groupId>
	<!-- 导入项目的名称 -->
	<artifactId>express</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>express</name>

	<properties>
		<java.version>1.8</java.version>
		<fastjson.version>1.2.8</fastjson.version>
		<maven-jar-plugin.version>3.1.1</maven-jar-plugin.version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
		<dependency>
			<groupId>org.mybatis.spring.boot</groupId>
			<artifactId>mybatis-spring-boot-starter</artifactId>
			<version>2.1.1</version>
		</dependency>
		<dependency>
		    <groupId>org.springframework.boot</groupId>
		    <artifactId>spring-boot-starter-jdbc</artifactId>
		</dependency>

		<dependency>
		    <groupId>mysql</groupId>
		    <artifactId>mysql-connector-java</artifactId>
		</dependency>
		<dependency>
			<groupId>org.apache.shiro</groupId>
			<artifactId>shiro-spring</artifactId>
			<version>1.3.2</version>
		</dependency>
		<dependency>
			<groupId>com.baomidou</groupId>
			<artifactId>mybatis-plus-boot-starter</artifactId>
			<version>3.4.3.1</version>
		</dependency>
		<dependency>
		    <groupId>com.google.protobuf</groupId>
		    <artifactId>protobuf-java</artifactId>
		    <version>3.10.0</version>
		</dependency>

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>

		<dependency>
		    <groupId>org.apache.commons</groupId>
		    <artifactId>commons-lang3</artifactId>
		    <version>3.0</version>
		</dependency>

		<dependency>
		    <groupId>javax.validation</groupId>
		    <artifactId>validation-api</artifactId>
		    <version>2.0.1.Final</version>
		</dependency>

		<dependency>
		    <groupId>commons-io</groupId>
		    <artifactId>commons-io</artifactId>
		    <version>2.5</version>
		</dependency>


		<dependency>
		    <groupId>cn.hutool</groupId>
		    <artifactId>hutool-all</artifactId>
		    <version>4.0.12</version>
		</dependency>

		<!-- FastJson -->
		<dependency>
			<groupId>com.alibaba</groupId>
			<artifactId>fastjson</artifactId>
			<version>${fastjson.version}</version>
		</dependency>

		<dependency>
		    <groupId>com.microsoft.sqlserver</groupId>
		    <artifactId>mssql-jdbc</artifactId>
		    <version>6.2.0.jre8</version>
		    <scope>runtime</scope>
		</dependency>
		<!-- 百度人工智能 -->
		<dependency>
    		<groupId>com.baidu.aip</groupId>
    		<artifactId>java-sdk</artifactId>
    		<version>4.4.1</version>
		</dependency>

        <dependency>
            <groupId>org.apache.poi</groupId>
            <artifactId>poi</artifactId>
            <version>3.11</version>
        </dependency>

        <dependency>
            <groupId>org.apache.poi</groupId>
            <artifactId>poi-ooxml</artifactId>
            <version>3.9</version>
        </dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-redis</artifactId>
		</dependency>

		<dependency>
			<groupId>com.github.pagehelper</groupId>
			<artifactId>pagehelper-spring-boot-starter</artifactId>
			<version>1.4.3</version>
		</dependency>



		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
			<exclusions>
				<exclusion>
					<groupId>org.junit.vintage</groupId>
					<artifactId>junit-vintage-engine</artifactId>
				</exclusion>
			</exclusions>
		</dependency>
	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>

</project>

```
## 配置代码
### 异常响应类
![img_3.png](qiantai/img_3.png)
### 工具类
![img_4.png](qiantai/img_4.png)
## 登录拦截器

这个类是全局接口的拦截器，请求任何接口都会到这里，可以看到我们刚开始判断如果请求方式是 OPTIONS，的话我们直接放行
因为这个OPTIONS请求方式是vue的预检查请求，我们不用管，接下来我们从请求头中获取了authorization，这个就是我们，登录接口返回的token，前端拿到以后会吧token放到请求头中，每次请求都带过来，带过来以后我们判断，如果没有带，直接提示token不存在，如果带了，我们判断这个token是否在redis中，如果不在提示用户未登录，因为我们登录接口会调用

成功以后，会直接进行吧token存储到redis中

```java
@Slf4j
@Component
public class LoginInterceptor implements HandlerInterceptor {


    @Autowired
    private RedisTemplate<String,String> redisTemplate;
    
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // 检查请求方法是否为 OPTIONS
        if ("OPTIONS".equals(request.getMethod().toUpperCase())) {
            // 如果是 OPTIONS 请求，直接返回 true，表示允许请求继续处理
            return true;
        }

        // 从请求头中获取 authorization 字段，即 token
        String token = request.getHeader("authorization");

        // 检查 token 是否为空
        if (StringUtils.isEmpty(token)) {
            // 如果 token 为空，抛出 BizException 异常，提示 token 不存在
            throw new BizException(401, "token不存在");
        }

        // 使用 redisTemplate 从 Redis 中获取与 token 相关的登录信息
        String login = redisTemplate.opsForValue().get("loginToken::" + token);

        // 检查登录信息是否为空
        if (StringUtils.isEmpty(login)) {
            // 如果登录信息为空，抛出 BizException 异常，提示用户未登录
            throw new BizException(401, "用户未登录");
        }

        // 返回 true，表示请求可以继续处理
        return true;
    }


}

```

指定哪些路径会被拦截以及哪些路径被排除在外

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Resource
    private LoginInterceptor loginInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // 响应走到这的时候是会访问 loginInterceptor
        // 所有请求都会经过 loginInterceptor，确保每个请求都经过身份验证和权限检查。
        registry.addInterceptor(loginInterceptor)
            	// 拦截所有路径
                .addPathPatterns("/**") 
             	// 排除特定路径
            	// /file/download 不拦截是用来回显头像的
                .excludePathPatterns("/user/login","/file/download");
    }

}
```

前端的拦截器校验

```js
import axios from 'axios';
import { Message } from 'element-ui';


// 创建 Axios 实例
const service = axios.create({
    baseURL: "http://localhost:8089/express", // 根据你的配置设置基础 URL
    timeout: 5000, // 请求超时时间
});

// 请求拦截器
service.interceptors.request.use(
    (config) => {
        // 在请求发送之前可以处理 token 等信息
        const token = localStorage.getItem('token');
        if (token) {
            config.headers.Authorization = `${token}`;
        }
        return config;
    },
    (error) => {
        // 请求错误处理
        console.error('Request Error:', error);
        return Promise.reject(error);
    }
);

// 响应拦截器
service.interceptors.response.use(
    (response) => {
        // 如果响应包含业务逻辑错误，例如非 200 状态
        const res = response.data;
        console.log("asdas213132");
        console.log(res);
        if (res.code !== 0) {
            Message.error(res.msg || 'Error');
            return Promise.reject(new Error(res.msg || 'Error'));
        } else {
            console.log("sadoooooo");
            return res;
        }
    },
    (error) => {
        if(error.response.status==500){
            Message({
                message: error.response.data.msg.length>20?'服务器响应异常':error.response.data.msg,
                type: 'error', // 类型可选：success, warning, info, error
                duration: 3000 // 持续时间（毫秒）
            });
        }else {
            Message({
                message: '网络连接异常',
                type: 'error', // 类型可选：success, warning, info, error
                duration: 3000 // 持续时间（毫秒）
            });
        }
        return Promise.reject(error);
    }
);

// 封装 GET 请求
export function get(url, params) {
    return service.get(url, { params });
}

// 封装 POST 请求
export function post(url, data) {
    return service.post(url, data);
}

// 封装 PUT 请求
export function put(url, data) {
    return service.put(url, data);
}

// 封装 DELETE 请求
export function del(url, params) {
    return service.delete(url, { params });
}

export default service;

```
## 手机号账号密码登录
### 说明
```text
描述：手机号或者账号密码登录接口
接口：/express/user/login
请求方式：post
```
### 书写Dto
```java
@Data
public class LoginDto {

    private String phone;

    private String code;

    private String username;

    private String password;

    /**
     * 登录类型，1手机号或者2用户名密码
     */
    @NotNull(message = "登录类型不能为空")
    private Integer loginType;
}

```
### 书写Controller

接口使用post请求方式进行调用，然后调用service层进行获取token最后返回给前端token

```java
@RestController
@RequestMapping("/user")
public class UserController {
    
    @Resource
    private UserService userService;
    
    /**
     * 登录接口
     * @param loginDto
     * @return
     */
    @PostMapping("/login")
    public R login(@RequestBody @Validated LoginDto loginDto){
        String token = userService.login(loginDto);
        return R.ok().put("token",token);
    }
}
```
### 书写Service 
```java
public interface UserService extends IService<User> {
    String login(LoginDto loginDto);
}
```
### 书写ServiceImpl

登录这块的话，手机号登录和验证码登录，都放在了一个接口中，根据前端传的`loginType`来判断，然后最后验证通过，生成token，调用`redis`把token信息存到`redis`中

```java
@Service
// 标记该类为一个服务组件
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {

    @Autowired
    // 使用 @Autowired 注解注入 RedisTemplate，用于操作 Redis 数据库
    private RedisTemplate<String, String> redisTemplate;

    @Override
    // 重写 login 方法，该方法接受 LoginDto 参数并返回一个字符串类型的 token
    public String login(LoginDto loginDto) {
        Integer loginType = loginDto.getLoginType();
        // 获取 loginDto 中的登录类型
        User user;
        // 定义一个 User 类型的变量 user

        switch (loginType) {
            case 1:
                // 手机号登录
                if (StringUtils.isEmpty(loginDto.getPhone())) {
                    // 检查手机号是否为空
                    throw new BizException("登陆手机号不能为空");
                }
                // 查询数据库中是否存在该手机号且未删除的用户
                user = this.lambdaQuery().eq(User::getPhone, loginDto.getPhone()).eq(User::getDelete, 0).one();
                if (user == null) {
                    // 如果用户不存在，抛出异常
                    throw new BizException("用户手机号不存在");
                }
                // 从 Redis 中获取验证码
                String code = redisTemplate.opsForValue().get("loginPhone::" + user.getPhone());
                if (StringUtils.isEmpty(code) || !loginDto.getCode().equals(code)) {
                    // 验证码为空或不匹配时，抛出异常
                    throw new BizException("验证码不正确");
                }
                break;
            case 2:
                // 账号密码登录
                if (StringUtils.isEmpty(loginDto.getUsername()) || StringUtils.isEmpty(loginDto.getPassword())) {
                    // 检查用户名和密码是否为空
                    throw new BizException("用户名或者密码不能为空");
                }
                // 查询数据库中是否存在该用户名且未删除的用户
                user = this.lambdaQuery().eq(User::getUsername, loginDto.getUsername()).eq(User::getDelete, 0).one();
                if (user == null) {
                    // 如果用户不存在，抛出异常
                    throw new BizException("用户名不存在");
                }
                // 校验密码是否正确
                String password = user.getPassword();
                if (!loginDto.getPassword().equals(password)) {
                    // 密码不匹配时，抛出异常
                    throw new BizException("密码不正确，请重新输入");
                }
                break;
            default:
                // 登录类型异常时，抛出异常
                throw new BizException("登陆类型异常");
        }

        // 生成一个随机的 UUID 并去除其中的 '-' 符号，作为 token
        String token = UUID.randomUUID().toString().replace("-", "");
        // 清除用户对象中的密码信息以保护隐私
        user.setPassword(null);
        // 将用户信息序列化成 JSON 字符串并存储到 Redis 中
        redisTemplate.opsForValue().set("loginToken::" + token, JSON.toJSONString(user));
        // 返回生成的 token
        return token;
    }
}

```
### 书写mapper层
```java
public interface UserMapper extends BaseMapper<User> {

}
```
### 前后端联调
浏览器输入：http://localhost:8090/#/oauth
![img_5.png](qiantai/img_5.png)
![img_6.png](qiantai/img_6.png)

## 获取验证码接口
### 说明
```text
描述：获取验证码接口
接口：/express/user/sendVerificationCode
请求方式：get
```
### 书写Controller
```java
   /**
     * 获取验证码
     * @param phone
     * @return
     */
    @GetMapping("/sendVerificationCode")
    public R sendVerificationCode(@RequestParam("phone") String phone){
        userService.sendVerificationCode(phone);
        return R.ok();
    }

```
### 书写service
```java
  String sendVerificationCode(String phone);
```
### 书写serviceImpl
```java
@Override
public String sendVerificationCode(String phone) {
    // 查询是否有该手机号且未被删除的用户
    User userForPhone = this.lambdaQuery().eq(User::getPhone, phone).eq(User::getDelete, 0).one();

    // 如果没有找到用户，抛出异常
    if (userForPhone == null) {
        throw new BizException("用户手机号不存在，请先去注册");
    }

    // 从 Redis 中获取已经存在的验证码
    String phoneCode = redisTemplate.opsForValue().get("loginPhone::" + phone);

    // 如果验证码已经存在，抛出异常
    if (StringUtils.isNotEmpty(phoneCode)) {
        throw new BizException("请勿重复获取验证码");
    }

    // 生成四位随机数字验证码
    String s = String.valueOf(generateFourDigitRandomNumber());

    // 将验证码存储到 Redis 中，并设置过期时间为1分钟
    redisTemplate.opsForValue().set("loginPhone::" + phone, s, 1, TimeUnit.MINUTES);

    // 输出日志信息
    System.out.println(phone + " 手机获取验证码，验证码 = " + s);

    // 返回生成的验证码
    return s;
}

 public int generateFourDigitRandomNumber() {
        return ThreadLocalRandom.current().nextInt(1000, 10000);
 }


```
### 前后端联调
浏览器输入：http://localhost:8090/#/oauth

![img_7.png](qiantai/img_7.png)

## 获取首页总支出总收入接口
### 说明
```text
描述：获取首页总支出总收入接口
接口：/express/accountion/record/totalPrice
请求方式：get
```
### 书写Vo
```java
@Data
public class TotalPriceVo {

    //每一个分类的总收入
    private List<TotalPriceVoData> classifyTotalIncome = new ArrayList<>();

    //每一份分类的总支出
    private List<TotalPriceVoData>  classifyTotalPay = new ArrayList<>();


    //总收入
    private BigDecimal totalIncome;

    //总支出
    private BigDecimal totalPay;

    @Data
    public static class TotalPriceVoData{
        private String name;

        private BigDecimal value;
    }
}
```
### 书写Controller
```java
@RestController
@RequestMapping("accountion/record")
public class AccountionRecordController {

    @Resource
    private UserService userService;

    @Resource
    private AccountionRecordService accountionRecordService;


    /**
     * 饼图展示
     * @return
     */
    @GetMapping("totalPrice")
    public R totalPrice(){
        TotalPriceVo totalPriceVo = accountionRecordService.totalPrice();
        return R.ok().put("data",totalPriceVo);
    }
}
```
### 书写service
```java
public interface AccountionRecordService extends IService<AccountionRecord> {

    TotalPriceVo totalPrice();
}
```
### 创建Classify三层

```java
@RestController
public class ClassifyController {
}

public interface ClassifyService extends IService<Classify> {
}

@Service
public class ClassifyServiceImpl  extends ServiceImpl<ClassifyMapper, Classify> implements ClassifyService {
}

public interface ClassifyMapper extends BaseMapper<Classify> {

}
```

### 书写获取当前登录用户的信息

```java
public interface UserService extends IService<User> {

    /**
     * 根据token获取用户
     * @return
     */
    User getLoginUser();
}


@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {
    
    @Autowired
    private HttpServletRequest request;

    // 获取登录用户信息的方法
    @Override
    public User getLoginUser() { 
        // 从请求头中获取 authorization 字段的值作为登录令牌
        String loginToken = request.getHeader("authorization"); 
        // 如果登录令牌为空，抛出业务异常
        if(StringUtils.isEmpty(loginToken)){ 
            throw new BizException("token 不能为空"); 
        }
        // 根据登录令牌从 Redis 中获取用户信息
        String userInfo = redisTemplate.opsForValue().get("loginToken::" + loginToken); 
        // 如果用户信息为空，抛出业务异常
        if(StringUtils.isEmpty(userInfo)){ 
            throw new BizException("token 无用户信息"); 
        }
        // 将用户信息解析为 User 对象
        User user = JSON.parseObject(userInfo, User.class); 
        // 获取用户 ID
        Integer id = user.getId(); 
        // 根据用户 ID 从数据库或其他数据源中获取用户对象
        User user2 = this.getById(id); 
        // 将用户密码设置为空，以保护用户隐私
        user2.setPassword(null); 
        // 返回用户对象
        return user2; 
    }


}
```

### 书写serviceImpl

```java
@Override
public TotalPriceVo totalPrice() {
    // 创建一个 TotalPriceVo 对象
    TotalPriceVo totalPriceVo = new TotalPriceVo();

    // 获取当前登录用户的信息
    User loginUser = userService.getLoginUser();

    // 查询用户的账务记录
    List<AccountionRecord> list = this.lambdaQuery()
            .eq(AccountionRecord::getUserId, loginUser.getId())
            .eq(AccountionRecord::getDelete, 0)
            .orderByDesc(AccountionRecord::getCreateTime)
            .list();
    
    // SQL 对应的查询语句
    /*
    SELECT * 
    FROM accountion_record 
    WHERE user_id = ? AND delete = 0 
    ORDER BY create_time DESC
    */

    // 计算总支出
    BigDecimal totalPay = list.stream()
            .filter(item -> item.getType() == 1) // 过滤出类型为支出（1）的记录
            .map(AccountionRecord::getPrice)     // 映射到价格字段
            .reduce(BigDecimal.ZERO, BigDecimal::add); // 累加所有价格

    // 计算总收入
    BigDecimal totalIncome = list.stream()
            .filter(item -> item.getType() == 2) // 过滤出类型为收入（2）的记录
            .map(AccountionRecord::getPrice)     // 映射到价格字段
            .reduce(BigDecimal.ZERO, BigDecimal::add); // 累加所有价格

    // 设置总支出和总收入到 TotalPriceVo 对象
    totalPriceVo.setTotalPay(totalPay);
    totalPriceVo.setTotalIncome(totalIncome);

    // 统计支出分类
    Map<Integer, List<AccountionRecord>> collect = list.stream()
            .filter(item -> item.getType() == 1) // 过滤出类型为支出（1）的记录
            .collect(Collectors.groupingBy(AccountionRecord::getClassifyId)); // 按分类ID分组

    // 处理支出分类数据
    for (Map.Entry<Integer, List<AccountionRecord>> entry : collect.entrySet()) {
        Integer key = entry.getKey(); // 获取分类ID
        List<AccountionRecord> value = entry.getValue(); // 获取对应记录列表

        // 查询分类名称
        Classify classify = classifyService.getById(key);

        // 组装数据
        TotalPriceVo.TotalPriceVoData totalPriceVoData = new TotalPriceVo.TotalPriceVoData();
        totalPriceVoData.setName(classify.getName()); // 设置分类名称
        totalPriceVoData.setValue(value.stream() // 计算分类内的总支出
                .map(AccountionRecord::getPrice) // 映射到价格字段
                .reduce(BigDecimal.ZERO, BigDecimal::add)); // 累加所有价格

        // 添加到 TotalPriceVo 的支出分类列表中
        totalPriceVo.getClassifyTotalPay().add(totalPriceVoData);
    }

    // 统计收入分类
    Map<Integer, List<AccountionRecord>> collect2 = list.stream()
            .filter(item -> item.getType() == 2) // 过滤出类型为收入（2）的记录
            .collect(Collectors.groupingBy(AccountionRecord::getClassifyId)); // 按分类ID分组

    // 处理收入分类数据
    for (Map.Entry<Integer, List<AccountionRecord>> entry : collect2.entrySet()) {
        Integer key = entry.getKey(); // 获取分类ID
        List<AccountionRecord> value = entry.getValue(); // 获取对应记录列表

        // 查询分类名称
        Classify classify = classifyService.getById(key);

        // 组装数据
        TotalPriceVo.TotalPriceVoData totalPriceVoData = new TotalPriceVo.TotalPriceVoData();
        totalPriceVoData.setName(classify.getName()); // 设置分类名称
        totalPriceVoData.setValue(value.stream() // 计算分类内的总收入
                .map(AccountionRecord::getPrice) // 映射到价格字段
                .reduce(BigDecimal.ZERO, BigDecimal::add)); // 累加所有价格

        // 添加到 TotalPriceVo 的收入分类列表中
        totalPriceVo.getClassifyTotalIncome().add(totalPriceVoData);
    }

    // 返回 TotalPriceVo 对象
    return totalPriceVo;
}
```
### 书写mapper
```java
public interface AccountionRecordMapper extends BaseMapper<AccountionRecord> {

}
```
### 前后端联调
浏览器输入：http://localhost:8090/#/home
![img_8.png](qiantai/img_8.png)

## 首页收支记录接口
### 说明
```text
描述：首页收支记录接口
接口：/express/accountion/record/list
请求方式：get
```
### 书写Controller
```java
  	/**
     * 收支记录
     * @return
     */
@GetMapping("list")
public R list(@RequestParam String remark) {
    // 获取当前登录用户的信息
    User loginUser = userService.getLoginUser();

    // 如果备注为空，则查询所有账务记录
    if (StringUtil.isEmpty(remark)) {
        // 构建查询条件：用户ID匹配且按ID降序排列
        
        /*
        	SELECT * 
            FROM accountion_record 
            WHERE user_id = ? AND delete = 0
            ORDER BY id DESC
        */
        List<AccountionRecord> list = accountionRecordService.lambdaQuery()
                .eq(AccountionRecord::getUserId, loginUser.getId())
            	.eq(AccountionRecord::getDelete,0)
                .orderByDesc(AccountionRecord::getId)
                .list();

        // 返回成功响应并附带查询结果
        return R.ok().put("data", list);
    } else {
        // 构建查询条件：用户ID匹配且备注包含指定字符串，按ID降序排列
        /*
            SELECT * 
            FROM accountion_record 
            WHERE user_id = ? AND delete = 0 AND remark LIKE ? 
            ORDER BY id DESC
        */
        List<AccountionRecord> list = accountionRecordService.lambdaQuery()
                .eq(AccountionRecord::getUserId, loginUser.getId())
                .like(AccountionRecord::getRemark, remark)
            	.eq(AccountionRecord::getDelete,0)
                .orderByDesc(AccountionRecord::getId)
                .list();

        // 返回成功响应并附带查询结果
        return R.ok().put("data", list);
    }
}
```
### 前后端联调
![img_9.png](qiantai/img_9.png)
## 删除收支记录接口
### 说明
```text
描述：删除收支记录接口
接口：/express/accountion/record/delete
请求方式：get
```
### 书写Controller
```java
 @GetMapping("delete")
    public R delete(@RequestParam Integer id){
        accountionRecordService.lambdaUpdate().set(AccountionRecord::getDelete,1)
                .eq(AccountionRecord::getId,id).update();
        return R.ok();
    }
```
### 前后端联调
浏览器输入：http://localhost:8090/#/home
![img_9.png](qiantai/img_9.png)
## 获取银行卡列表接口
### 说明
```text
描述：获取银行卡列表接口
接口：/express/bank/select
请求方式：get
```
### 书写Controller
```java
@RestController
@RequestMapping("bank")
public class BankController {

    @Resource
    // 使用 @Resource 注解注入 BankService，用于调用银行相关服务
    private BankService bankService;

    @Resource
    // 使用 @Resource 注解注入 UserService，用于获取当前登录用户的信息
    private UserService userService;

    @GetMapping("select")
    // 处理 GET 请求，请求路径为 /bank/select
    public R select() {
        // 获取当前登录用户的详细信息
        User user = userService.getLoginUser();

        // 查询数据库中未删除且属于当前用户的银行记录
        List<Bank> list = bankService.lambdaQuery()
                .eq(Bank::getDelete, 0)
                .eq(Bank::getUserId, user.getId())
                .list();

        // 对每个银行记录进行处理
        for (Bank bank : list) {
            // 如果银行编号长度大于 4，则截取前 4 位显示
            if (bank.getBankNum().length() > 4) {
                bank.setBankNum(bank.getBankNum().substring(0, 4));
            }
        }

        // 返回成功响应，并将查询结果放入响应体中
        return R.ok().put("data", list);
    }
}

```
### 书写Service
```java
public interface BankService extends IService<Bank> {

}
```
### 书写ServiceImpl
```java
@Service
public class BankServiceImpl extends ServiceImpl<BankMapper, Bank>
    implements BankService{

}

```
### 书写Mapper
```java
public interface BankMapper extends BaseMapper<Bank> {

}
```
### 前后端联调
浏览器输入：http://localhost:8090/#/bankCard
![img_10.png](qiantai/img_10.png)
## 删除银行卡接口
### 说明
```text
描述：删除银行卡接口
接口：/express/bank/delete
请求方式：post
```
### 书写Controller
```java
    @PostMapping("delete")
    public R delete(@RequestBody Bank bank) {
        bankService.lambdaUpdate().eq(Bank::getId,bank.getId())
                .set(Bank::getDelete,1).update();
        return R.ok();
    }
```
### 前后端联调
浏览器输入：http://localhost:8090/#/bankCard
![img_11.png](qiantai/img_11.png)
## 修改银行卡接口
### 说明
```text
描述：修改银行卡接口
接口：/express/bank/update
请求方式：post
```
### 书写Controller
```java
   @PostMapping("update")
    public R update(@RequestBody Bank bank) {
        bankService.updateById(bank);
        return R.ok();
    }
```
### 前后端联调
http://localhost:8090/#/addCard?id=4&name=%E5%B7%A5%E5%95%86%E9%93%B6%E8%A1%8C&bankNum=9999
![img_12.png](qiantai/img_12.png)
## 增加银行卡接口
### 说明
```text
描述：增加银行卡接口
接口：/express/bank/insert
请求方式：post
```
### 书写Controller
```java
@PostMapping("insert")
// 处理 POST 请求，请求路径为 /bank/insert
public R insert(@RequestBody Bank bank) {
    // 获取当前登录用户的详细信息
    User loginUser = userService.getLoginUser();
    
    // 设置银行的用户 ID、创建时间和银行卡类型
    bank.setUserId(loginUser.getId());
    bank.setCreateTime(new Date());
    bank.setBankType("储蓄卡");

    // 根据银行名称设置银行的 Logo、限额和背景颜色
    switch (bank.getName()) {
        case "建设银行":
            bank.setBankLogo("/img/jianhang.5f2be68a.svg");
            bank.setLimitNum("20");
            bank.setBankBg("#3973c4");
            break;
        case "工商银行":
            bank.setBankLogo("/img/gongshang.041b6acf.svg");
            bank.setLimitNum("50");
            bank.setBankBg("#fe6063");
            break;
        case "农业银行":
        default:
            bank.setBankLogo("/img/nonghang.077a47b6.svg");
            bank.setLimitNum("40");
            bank.setBankBg("#32977f");
            break;
    }

    // 保存银行信息到数据库
    bankService.save(bank);

    // 返回成功响应
    return R.ok();
}

```
### 前后端联调
浏览器输入：http://localhost:8090/#/addCard
![img_13.png](qiantai/img_13.png)

## 获取统计报表中年月度收支情况接口
### 说明
```text
描述：获取统计报表中年月度收支情况接口
接口：/express/accountion/record/selectByIndex
请求方式：get
```
### 书写Vo
```java
@Data
public class SelectByIndexVo {

    //总收入
    private BigDecimal totalIncome = new BigDecimal("0");

    //总支出
    private BigDecimal totalPay = new BigDecimal("0");

    //平均每日支出
    private BigDecimal averageDayPay = new BigDecimal("0");

    private List<DetailInfo> detailInfos = new ArrayList<>();

    @Data
    public static class DetailInfo{
        //1、1支出 2收入
        private Integer type;

        //金额
        private BigDecimal price;

        private String time;
    }
    
}

```
### 书写Controller
```java
    /**
     * 首页数据
     * @param mongth
     * @param year
     * @return
     */
    @GetMapping("selectByIndex")
    public R selectByIndex(@RequestParam(required = false) Integer mongth,
                           @RequestParam(required = false) Integer year){
        SelectByIndexVo selectByIndexVo = accountionRecordService.selectByIndex(mongth,year);
        return R.ok().put("data",selectByIndexVo);
    }
```
### 书写Service
```java
    SelectByIndexVo selectByIndex(Integer mongth, Integer year);
```
### 书写ServiceImpl
```java
	/**
     * 获取指定年月天数
     * @param year
     * @param month
     * @return
     */
    public static int getDaysInMonth(int year, int month) {
        YearMonth yearMonth = YearMonth.of(year, month);
        return yearMonth.lengthOfMonth(); // 返回这个月的天数
    }

@Override
public SelectByIndexVo selectByIndex(Integer month, Integer year) {
    // 获取当前登录用户的信息
    User loginUser = userService.getLoginUser();

    // 创建一个 SelectByIndexVo 对象
    SelectByIndexVo selectByIndexVo = new SelectByIndexVo();

    // 初始化账务记录列表
    List<AccountionRecord> list = new ArrayList<>();

    // 根据传入的月份筛选账务记录
    /*
        SELECT *
        FROM accountion_record
        WHERE delete = 0 AND user_id = ?
        ORDER BY id DESC
    */
    if (month != null) {
        list = this.lambdaQuery()
                .eq(AccountionRecord::getMonth, month) // 条件：月份等于指定值
                .eq(AccountionRecord::getDelete, 0)    // 条件：删除标志为0
                .eq(AccountionRecord::getUserId, loginUser.getId()) // 条件：用户ID匹配
                .orderByDesc(AccountionRecord::getId)  // 按ID降序排列
                .list(); // 执行查询
    }

    // 根据传入的年份筛选账务记录
    if (year != null) {
        list = this.lambdaQuery()
                .eq(AccountionRecord::getYear, year)   // 条件：年份等于指定值
                .eq(AccountionRecord::getDelete, 0)    // 条件：删除标志为0
                .eq(AccountionRecord::getUserId, loginUser.getId()) // 条件：用户ID匹配
                .orderByDesc(AccountionRecord::getId)  // 按ID降序排列
                .list(); // 执行查询
    }

    // 如果账务记录列表为空，直接返回空的 SelectByIndexVo 对象
    if (CollectionUtils.isEmpty(list)) {
        return selectByIndexVo;
    }

    // 如果账务记录列表不为空，计算总支出和总收入
    if (CollectionUtils.isNotEmpty(list)) {
        // 获取总支出
        BigDecimal totalPay = list.stream()
                .filter(item -> item.getType() == 1) // 过滤出类型为支出（1）的记录
                .map(AccountionRecord::getPrice)     // 映射到价格字段
                .reduce(BigDecimal.ZERO, BigDecimal::add); // 累加所有价格
        selectByIndexVo.setTotalPay(totalPay);

        // 获取总收入
        BigDecimal totalIncome = list.stream()
                .filter(item -> item.getType() == 2) // 过滤出类型为收入（2）的记录
                .map(AccountionRecord::getPrice)     // 映射到价格字段
                .reduce(BigDecimal.ZERO, BigDecimal::add); // 累加所有价格
        selectByIndexVo.setTotalIncome(totalIncome);
    }

    // 如果传入了年份，计算平均日支出并组装详情信息
    if (year != null) {
        // 计算平均日支出
        selectByIndexVo.setAverageDayPay(selectByIndexVo.getTotalPay()
                .divide(new BigDecimal(12), 2, BigDecimal.ROUND_HALF_UP));

        // 组装详情信息
        List<SelectByIndexVo.DetailInfo> detailInfoList = list.stream()
                .collect(Collectors.groupingBy(
                        AccountionRecord::getMonth, // 按照月份分组
                        Collectors.groupingBy(
                                AccountionRecord::getType, // 按照类型分组
                                Collectors.reducing(BigDecimal.ZERO, AccountionRecord::getPrice, BigDecimal::add) // 计算总金额
                        )
                ))
                .entrySet().stream()
                .flatMap(monthEntry -> monthEntry.getValue().entrySet().stream()
                        .map(typeEntry -> {
                            SelectByIndexVo.DetailInfo detailInfo = new SelectByIndexVo.DetailInfo();
                            detailInfo.setTime(monthEntry.getKey()); // 设置时间（月份）
                            detailInfo.setType(typeEntry.getKey());  // 设置类型（支出或收入）
                            detailInfo.setPrice(typeEntry.getValue()); // 设置总金额
                            return detailInfo;
                        })
                )
                .collect(Collectors.toList());

        selectByIndexVo.setDetailInfos(detailInfoList);
    }

    // 如果传入了月份，计算平均日支出并组装详情信息
    if (month != null) {
        int daysInMonth = getDaysInMonth(Integer.parseInt(list.get(0).getYear()), month);
        String year1 = list.get(0).getYear();
        // 计算平均日支出
        selectByIndexVo.setAverageDayPay(selectByIndexVo.getTotalPay()
                .divide(new BigDecimal(daysInMonth), 2, BigDecimal.ROUND_HALF_UP));

        // 组装详情信息
        List<SelectByIndexVo.DetailInfo> detailInfoList = list.stream()
                .collect(Collectors.groupingBy(
                        AccountionRecord::getDay, // 按照天数分组
                        Collectors.groupingBy(
                                AccountionRecord::getType, // 按照类型分组
                                Collectors.reducing(BigDecimal.ZERO, AccountionRecord::getPrice, BigDecimal::add) // 计算总金额
                        )
                ))
                .entrySet().stream()
                .flatMap(monthEntry -> monthEntry.getValue().entrySet().stream()
                        .map(typeEntry -> {
                            SelectByIndexVo.DetailInfo detailInfo = new SelectByIndexVo.DetailInfo();
                            detailInfo.setTime(monthEntry.getKey());
                            detailInfo.setType(typeEntry.getKey());
                            detailInfo.setPrice(typeEntry.getValue());
                            return detailInfo;
                        })
                )
                .collect(Collectors.toList());

        selectByIndexVo.setDetailInfos(detailInfoList);
    }

    // 返回 SelectByIndexVo 对象
    return selectByIndexVo;
}
```
### 前后端联调
浏览器输入：http://localhost:8090/#/middle

![Clip_2024-10-28_00-40-07](./images/Clip_2024-10-28_00-40-07.png)

## 设置预算接口
### 说明
```text
描述：设置预算接口
接口：/express/budget/insert
请求方式：post
```
### 书写Controller

根据当前登录用户的ID和预算类型来判断是否已有相应的预算记录。如果有，则更新该记录；如果没有，则插入新的预算记录

```java
@RestController
@RequestMapping("/budget/")
public class BudgetController {


    @Resource
    private BudgetService budgetService;
    @Resource
    private UserService userService;


    @PostMapping("insert")
    public R insert(@RequestBody Budget budget) {
        // 获取当前登录用户的信息
        User loginUser = userService.getLoginUser();

        // 查询数据库中是否存在与当前登录用户和预算类型相匹配的预算记录
        Budget one = budgetService.lambdaQuery()
                .eq(Budget::getUserId, loginUser.getId()) // 条件：用户ID匹配
                .eq(Budget::getType, budget.getType())    // 条件：预算类型匹配
                .one(); // 执行查询并返回单条记录

        // 如果存在匹配的预算记录
        if (one != null) {
            // 更新现有预算记录
            budget.setId(one.getId()); // 设置预算ID为现有的ID
            budgetService.updateById(budget); // 更新预算记录
        } else {
            // 如果不存在匹配的预算记录，则插入新的预算记录
            budget.setUserId(loginUser.getId()); // 设置用户ID
            budgetService.save(budget); // 插入新的预算记录
        }

        // 返回成功响应
        return R.ok();
    }

}
```
### 书写Service
```java
public interface BudgetService extends IService<Budget> {

}
```
### 书写ServiceImpl
```java
@Service
public class BudgetServiceImpl extends ServiceImpl<BudgetMapper, Budget>
    implements BudgetService{

}

```
### 书写Mapper
```java
public interface BudgetMapper extends BaseMapper<Budget> {

}
```
### 前后端联调
浏览器输入：http://localhost:8090/#/middle
![img_15.png](qiantai/img_15.png)
## 获取收支明细接口
### 说明
```text
描述：获取收支明细接口
接口：/express/accountion/record/selectByDetail
请求方式：get
```
### 书写Controller
```java
@GetMapping("selectByDetail")
public R selectByDetail(Integer mongth) {
    // 创建日期格式化对象
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy");

    // 获取当前登录用户的信息
    User loginUser = userService.getLoginUser();

    // 查询账务记录
    /*
    	SELECT *
        FROM accountion_record
        WHERE delete = 0
          AND user_id = ?
          AND mongth = ?
          AND year = YEAR(CURDATE())
        ORDER BY create_time DESC
    */
    List<AccountionRecord> list = accountionRecordService.lambdaQuery()
            .eq(AccountionRecord::getDelete, 0)                          // 条件：未删除
            .eq(AccountionRecord::getUserId, loginUser.getId())         // 条件：用户ID匹配
            .eq(AccountionRecord::getMonth, mongth)                      // 条件：月份匹配
            .eq(AccountionRecord::getYear, sdf.format(new Date()))      // 条件：年份匹配
            .orderByDesc(AccountionRecord::getCreateTime)               // 按创建时间降序排序
            .list();                                                     // 执行查询并返回结果列表

    // 返回成功响应，并附带查询结果
    return R.ok().put("data", list);
}

```
### 前后端联调
浏览器输入：http://localhost:8090/#/income
![img_16.png](qiantai/img_16.png)

## 获取分类列表接口
### 说明
```text
描述：获取分类列表接口
接口：/express/classify/select
请求方式：get
```
### 书写Controller
```java
@RestController
@RequestMapping("classify")
public class ClassifyController {
    
    @Resource
    private ClassifyService classifyService;
    
    @Resource
    private UserService userService;

    /*
	SELECT *
    FROM classify
    WHERE delete = 0
  	AND (user_id = ? OR user_id = 0)
*/
    @GetMapping("select")
    public R select() {
        // 获取当前登录用户的信息
        User user = userService.getLoginUser();

        // 查询分类信息
        List<Classify> list = classifyService.lambdaQuery()
                .eq(Classify::getDelete, 0) // 条件：未删除
                .and(wrapper -> wrapper
                        .eq(Classify::getUserId, user.getId()) // 条件：用户ID匹配
                        .or().eq(Classify::getUserId, 0)       // 或者用户ID为0
                )
                .list(); // 执行查询并返回结果列表

        // 返回成功响应，并附带查询结果
        return R.ok().put("data", list);
    }
}
```
### 前后端联调
浏览器输入：http://localhost:8090/#/classfiy
![img_18.png](qiantai/img_18.png)

## 新增记账接口
### 说明
```text
描述：新增记账接口
接口：/express/accountion/record/insert
请求方式：post
```
### 书写Controller
```java
  	@PostMapping("insert")
    public R insert(@RequestBody AccountionRecord accountionRecord){
        accountionRecordService.insert(accountionRecord);
        return R.ok();
    }
```
### 书写Service
```java
 void insert(AccountionRecord accountionRecord);
```
### ServiceImpl添加获取日期的方法

```java
public static int getDayFromDate(Date date) {
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date); // 设置时间
        return calendar.get(Calendar.DAY_OF_MONTH); // 获取日
    }


    // 获取月份
    public static int getMonth(Date date) {
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        return calendar.get(Calendar.MONTH) + 1; // Java月份从0开始，所以要加1
    }

    // 获取年份
    public static int getYear(Date date) {
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        return calendar.get(Calendar.YEAR);
    }
```

### 书写ServiceImpl

```java
@Override
public void insert(AccountionRecord accountionRecord) {
    // 查询分类信息
    Classify classify = classifyService.lambdaQuery()
            .eq(Classify::getName, accountionRecord.getTypeName()) // 条件：分类名称匹配
            .list() // 执行查询并返回结果列表
            .get(0); // 获取第一个结果

    // 获取当前登录用户的信息
    User loginUser = userService.getLoginUser();

    // 设置账务记录的相关字段
    accountionRecord.setClassifyId(classify.getId()); // 设置分类ID
    accountionRecord.setUserId(loginUser.getId());     // 设置用户ID
    accountionRecord.setYear(getYear(accountionRecord.getTime()) + ""); // 设置年份
    accountionRecord.setMonth(getMonth(accountionRecord.getTime()) + ""); // 设置月份
    accountionRecord.setDay(getDayFromDate(accountionRecord.getTime()) + ""); // 设置日期
    accountionRecord.setType(classify.getType()); // 设置类型

    // 保存账务记录
    this.save(accountionRecord);
}
```
### 前后端联调
浏览器输入：http://localhost:8090/#/account
![img_17.png](qiantai/img_17.png)

## 删除分类接口
### 说明
```text
描述：删除分类接口
接口：/express/classify/delete
请求方式：get
```
### 书写Controller
```java
    /**
     * 处理删除分类的请求
     *
     * @param classify 分类信息
     * @return 响应结果，成功时返回 R.ok()
     * @sql UPDATE classify SET delete = 1 WHERE id =?;
     */
    @PostMapping("delete")
    public R delete(@RequestBody Classify classify){
        // 通过 lambdaUpdate 进行条件更新操作
        classifyService.lambdaUpdate().eq(Classify::getId,classify.getId())
                // 设置分类的删除字段为 1
                .set(Classify::getDelete,1)
                // 更新数据
                .update();
        return R.ok();
    }
```
### 前后端联调
浏览器输入：http://localhost:8090/#/classfiy
![img_19.png](qiantai/img_19.png)
## 新增分类接口
### 说明
```text
描述：新增分类接口
接口：/express/classify/insert
请求方式：post
```
### 书写Controller
```java
@PostMapping("insert")
public R insert(@RequestBody Classify classify) {
    // 获取当前登录用户的详细信息
    User loginUser = userService.getLoginUser();

    // 设置分类的用户 ID
    classify.setUserId(loginUser.getId());

    // 保存分类信息到数据库
    classifyService.save(classify);

    // 返回成功响应
    return R.ok();
}

```
### 前后端联调
浏览器输入：http://localhost:8090/#/classfiyDrtail
![img_20.png](qiantai/img_20.png)
## 修改分类接口
### 说明
```text
描述：修改分类接口
接口：/express/classify/update
请求方式：post
```
### 书写Controller
```java
  	@PostMapping("update")
    public R update(@RequestBody Classify classify){
        classifyService.updateById(classify);
        return R.ok();
    }

```
### 前后端联调
浏览器输入：http://localhost:8090/#/classfiyDrtail?id=2&name=%E6%B5%8B%E8%AF%952221232&type=%E6%94%B6%E5%85%A5
![img_21.png](qiantai/img_21.png)
## 超出预算消息提醒接口
### 说明
```text
描述：超出预算消息提醒接口
接口：/express/accountion/record/getBudgetExceed
请求方式：get
```
### 书写Controller
```java
@Resource
private BudgetService budgetService;

@GetMapping("getBudgetExceed")
public R getBudgetExceed() {
    // 获取当前登录用户的信息
    User loginUser = userService.getLoginUser();

    // 获取当前日期
    LocalDate currentDate = LocalDate.now();

    // 获取当前月份（1-12）
    int currentMonth = currentDate.getMonthValue();

    // 查询账务记录
    /*
    	SELECT *
        FROM accountion_record
        WHERE user_id = ?
          AND type = 1
          AND delete = 0
          AND month = MONTH(CURDATE())
    */
    List<AccountionRecord> list = accountionRecordService.lambdaQuery()
            .eq(AccountionRecord::getUserId, loginUser.getId()) // 条件：用户ID匹配
            .eq(AccountionRecord::getType, 1)                    // 条件：类型为支出
            .eq(AccountionRecord::getDelete, 0)                  // 条件：未删除
            .eq(AccountionRecord::getMonth, currentMonth)        // 条件：当前月份
            .list();                                             // 执行查询并返回结果列表

    // 计算总支出金额
    BigDecimal totalPay = list.stream()
            .map(AccountionRecord::getPrice)                     // 映射到价格字段
            .reduce(BigDecimal.ZERO, BigDecimal::add);          // 累加计算总支出

    // 查询预算信息
    List<Budget> budgets = budgetService.lambdaQuery()
            .eq(Budget::getUserId, loginUser.getId())           // 条件：用户ID匹配
            .eq(Budget::getType, 2)                             // 条件：类型为预算
            .list();                                            // 执行查询并返回结果列表

    // 如果没有找到预算信息，则返回成功响应
    if (CollectionUtils.isEmpty(budgets)) {
        return R.ok();
    }

    // 如果总支出大于预算金额，则返回警告信息
    if (totalPay.doubleValue() > budgets.get(0).getBudgetPrice().doubleValue()) {
        return R.ok().put("data",
                "您本月预算为" + budgets.get(0).getBudgetPrice().doubleValue() + "元，已经支出" +
                        totalPay.doubleValue() + "元，请注意！");
    }

    // 如果总支出未超过预算金额，则返回成功响应
    return R.ok();
}

```
### 前后端联调
浏览器输入：http://localhost:8090/#/personalCenter
![img_22.png](qiantai/img_22.png)
## 获取当前登录用户接口
### 说明
```text
描述：获取当前登录用户接口
接口：/express/user/getLoginUser
请求方式：get
```
### 书写Controller
```java
@GetMapping("/getLoginUser")
    public R getLoginUser(){
        User user = userService.getLoginUser();
        return R.ok().put("user",user);
    }
```
### 前后端联调
浏览器输入：http://localhost:8090/#/personalCenter
![img_23.png](qiantai/img_23.png)
## 获取消费占比数据接口
### 说明
```text
描述：获取消费占比数据接口
接口：/express/accountion/record/totalPrice
请求方式：get
```
### 该接口上面已经存在
### 前后端联调
浏览器输入：http://localhost:8090/#/personalCenter
![img_24.png](qiantai/img_24.png)
## 获取今日消费支出数据
### 说明
```text
描述：获取今日消费支出数据
接口：/express/accountion/record/selectByDay
请求方式：get
```
### 书写Vo
```java
@Data
public class DayVo {

    private List<AccountionRecord> accountionRecordList;

    //总收入
    private BigDecimal totalIncome;

    //总支出
    private BigDecimal totalPay;
}

```
### 书写Controller
```java
    /**
     * 某一天的明细数据
     * @return
     */
    @GetMapping("selectByDay")
    public R selectByDay(){
        DayVo dayVo = accountionRecordService.selectByDay(new Date());
        return R.ok().put("data",dayVo);
    }
```
### 书写Service
```java
    DayVo selectByDay(Date day);
```
### 书写ServiceImpl
```java
@Override
public DayVo selectByDay(Date day) {
    // 获取当前登录用户的详细信息
    User loginUser = userService.getLoginUser();

    // 创建 DayVo 对象用于封装结果
    DayVo dayVo = new DayVo();

    // 创建日期格式化对象
    SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd");

    // 查询符合条件的账户记录列表
    List<AccountionRecord> list = this.lambdaQuery()
    		// 查询指定年月日保存的数据
            .eq(AccountionRecord::getYear,getYear(day))
            .eq(AccountionRecord::getMonth,getMonth(day))
            .eq(AccountionRecord::getDay,getDayFromDate(day))
    		// 用户 ID 等于当前登录用户的 ID。
            .eq(AccountionRecord::getUserId, loginUser.getId())
    		// 删除标记等于 0（未删除）。
            .eq(AccountionRecord::getDelete, 0)
    		// 按创建时间降序排列。
            .orderByDesc(AccountionRecord::getCreateTime)
            .list();

    // 将查询结果设置到 DayVo 对象中
    dayVo.setAccountionRecordList(list);

    // 如果查询结果不为空
    if (CollectionUtils.isNotEmpty(list)) {
        // 获取总支出
        // 使用流操作过滤出类型为 1（支出）的记录，并计算价格之和，得到总支出。
        BigDecimal totalPay = list.stream()
                .filter(item -> item.getType() == 1)
                .map(AccountionRecord::getPrice)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        dayVo.setTotalPay(totalPay);

        // 获取总收入
        // 使用流操作过滤出类型为 2（收入）的记录，并计算价格之和，得到总收入。
        BigDecimal totalIncome = list.stream()
                .filter(item -> item.getType() == 2)
                .map(AccountionRecord::getPrice)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        dayVo.setTotalIncome(totalIncome);
    }

    // 返回 DayVo 对象
    return dayVo;
}

```
### 前后端联调
浏览器输入：http://localhost:8090/#/personalCenter
![img_25.png](qiantai/img_25.png)

## 修改个人信息接口

### 说明

```text
描述：修改个人信息接口
接口：/express/user/updateLoginUser
请求方式：get
```

### 书写Dto

```java
@Data
public class UpdateUserDto {


    /**
     * 手机号
     */
    private String phone;

    /**
     * 真实姓名
     */
    private String name;

    /**
     * 身份证号
     */
    private String idCard;

    /**
     * 头像
     */
    private String head;

    /**
     * 0男 1女 2保密
     */
    private Integer sex;

    /**
     * 年龄
     */
    private Integer age;

    /**
     * 真实图片
     */
    private Long img;

    private String password;

}
```

### 书写Controller

```java
   /**
     * 更新当前登录用户信息
     * @param updateUserDto
     * @return
     */
    @PostMapping("/updateLoginUser")
    public R updateLoginUser(@RequestBody UpdateUserDto updateUserDto){
        userService.updateLoginUser(updateUserDto);
        return R.ok();
    }
```

### 书写Service

```java
    void updateLoginUser(UpdateUserDto updateUserDto);
```

### 书写ServiceImpl

```java
@Override
public void updateLoginUser(UpdateUserDto updateUserDto) {
    // 获取请求头中的 token
    String loginToken = request.getHeader("token");

    // 获取当前登录用户的信息
    User loginUser = getLoginUser();
    Integer id = loginUser.getId();

    // 创建一个新的 User 对象
    User user = new User();
    BeanUtils.copyProperties(updateUserDto, user);
    user.setPhoto(updateUserDto.getImg());
    user.setId(id);

    // 如果没有提供新密码，则保留原有密码
    if (StringUtils.isEmpty(updateUserDto.getPassword())) {
        User selUser = this.getById(id);
        user.setPassword(selUser.getPassword());
    }

    // 更新用户信息
    this.updateById(user);

    // 查询更新后的用户信息
    User newUser = this.getById(id);

    // 刷新 Redis 中的用户信息
    redisTemplate.opsForValue().set("loginToken::" + loginToken, JSON.toJSONString(newUser));
}

```

### 前后端联调

浏览器输入：http://localhost:8090/#/personalMessage
![img.png](qiantai/q1.png)

## 上传文件接口

### 说明
```text
描述：上传文件接口
接口：/express/file/upload
请求方式：post
```
### Vo

```java

```

### 书写Controller

```java
@RequestMapping("/file")
@Controller
public class FileController {

    // 定义文件保存路径，使用你自己的实际路径
    public static final String FILE_PATH = "/path/to/your/directory/";

    @Resource
    private CommonFileService commonFileService;

    @PostMapping("/upload")
    @ResponseBody
    public R uploadFile(@RequestParam("file") MultipartFile file) {
        // 检查上传文件是否为空
        if (file == null) {
            throw new BizException("上传文件不能为空");
        }

        try {
            // 获取原始文件名
            String originalFilename = file.getOriginalFilename();

            // 构造文件保存路径
            String filePath = FILE_PATH + UUID.randomUUID().toString().replace("-", "") + "-" + originalFilename;

            // 保存文件到服务器
            file.transferTo(new File(filePath));

            // 创建 CommonFile 对象
            CommonFile commonFile = new CommonFile();
            commonFile.setFileName(originalFilename);
            commonFile.setFileUrl(filePath);
            
            // 生成唯一 ID
            long uniqueId = SnowflakeUtil.getUniqueId();
            commonFile.setId(uniqueId);

            // 保存文件信息到数据库
            commonFileService.save(commonFile);

            // 创建返回对象
            FileUploadVo fileUploadVo = new FileUploadVo();
            fileUploadVo.setFileId(uniqueId);

            // 返回成功响应
            return R.ok().put("data", fileUploadVo);
        } catch (Exception e) {
            e.printStackTrace();
            throw new BizException("上传文件异常");
        }
    }
}

```
### 书写Service
```java
public interface CommonFileService extends IService<CommonFile> {

}
```
### 书写ServiceImpl
```java
@Service
public class CommonFileServiceImpl extends ServiceImpl<CommonFileMapper, CommonFile>
    implements CommonFileService{

}

```
### 书写Mapper
```java
public interface CommonFileMapper extends BaseMapper<CommonFile> {

}
```
### 前后端联调
浏览器输入：http://localhost:8090/#/personalMessage
![img.png](qiantai/q2.png)
## 预览文件接口
### 说明
```text
描述：预览文件接口
接口：/express/file/download
请求方式：get
```
### 书写Controller
```java
@GetMapping("/download")
    public void downloadFile(@NotEmpty(message = "文件Id不能为空") @RequestParam String fileId, HttpServletResponse response) {
        //根据文件Id查询文件
        CommonFile commonFile = commonFileService.getById(fileId);
        if(commonFile == null){
            throw new BizException("文件Id不存在");
        }
        File file = new File(commonFile.getFileUrl());

        // 检查文件是否存在
        if (!file.exists()) {
            throw new BizException("文件不存在");
        }
        String encodedFileName = commonFile.getFileName();
        try {
            encodedFileName = URLEncoder.encode(commonFile.getFileName(), "UTF-8");
        } catch (Exception e) {
            e.printStackTrace();
        }
        // 设置响应头，指定文件名为attachment下载
        response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);
        response.setHeader(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename*=UTF-8''" + encodedFileName);

        // 写入文件流到响应
        try (FileInputStream fis = new FileInputStream(file)) {
            byte[] buffer = new byte[1024];
            int bytesRead;
            while ((bytesRead = fis.read(buffer)) != -1) {
                response.getOutputStream().write(buffer, 0, bytesRead);
            }
            response.flushBuffer();
        } catch (Exception e){
            e.printStackTrace();
            throw new BizException("获取文件异常");
        }
    }
```
### 前后端联调
浏览器输入：http://localhost:8090/#/personalMessage

![Clip_2024-10-28_02-23-01](./images/Clip_2024-10-28_02-23-01.png)
